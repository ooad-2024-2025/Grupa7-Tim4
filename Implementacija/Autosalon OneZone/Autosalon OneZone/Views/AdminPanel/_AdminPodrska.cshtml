@* Fajl: Views/AdminPanel/_AdminPodrska.cshtml - IZMIJENJENO za dinamičko učitavanje *@
@model Autosalon_OneZone.ViewModels.Admin.PodrskaListViewModel

@* Preporuka: Uklonite CSS linkove iz parcijalnih viewa i stavite ih u glavni _CustomLayout.cshtml *@
@* <link href="~/css/admin-specific.css" rel="stylesheet" /> *@
@* <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"> *@

<h3>Pregled Upita za Podršku</h3>

@* Polje za pretragu i dugme *@
<div class="admin-section-controls">
    <input type="text" id="podrska-search-input" placeholder="Pretraži (email, naslov, sadržaj)..." value="@Model.SearchQuery" />
    <button id="podrska-search-button" class="btn btn-secondary">Pretraži</button>
    @* Ovdje možete dodati kontrole za sortiranje/paginaciju *@
</div>

@* Lista upita za podršku - Samo struktura tabele *@
<div id="podrska-list-container">
    <table class="table table-striped table-hover"> @* Dodane Bootstrap klase za stil *@
        <thead>
            <tr>
                @* Headeri kolona *@
                <th>Datum</th>
                <th>Email Korisnika</th>
                <th>Naslov Upita</th>
                <th>Poruka</th>
                <th>Status</th>
                <th>Akcije</th>
            </tr>
        </thead>
        <tbody id="podrska-table-body">
            @* Ovdje će se dinamički učitavati redovi tabele putem JavaScripta *@
            <tr>
                <td colspan="6">Učitavanje upita...</td> @* Početni placeholder *@
            </tr>
        </tbody>
    </table>
    @* Placeholder za paginaciju *@
    <div id="pagination-controls">
        @* Paginacija će se renderovati ovdje, ili dinamički kreirati/ažurirati JS-om *@
    </div>
</div>

@* SKRIPT BLOK ZA OVU SEKCIJU *@
<script>
    $(document).ready(function () {
        console.log("_AdminPodrska.cshtml script loaded and ready.");

        const podrskaTableBody = $('#podrska-table-body');
        const searchInput = $('#podrska-search-input');
        const searchButton = $('#podrska-search-button');

        // Funkcija za formatiranje datuma i vremena (JavaScript ekvivalent ToString("dd.MM.yyyy HH:mm"))
        function formatDateTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return ''; // Provjera ispravnosti datuma

            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Mjeseci su 0-indeksirani
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');

            return `${day}.${month}.${year} ${hours}:${minutes}`;
        }

        // Funkcija za učitavanje liste upita za podršku putem AJAX-a
        function loadUpitiList(searchQuery = '', page = 1, sortOrder = '') {
            console.log("Loading support ticket list...");
            podrskaTableBody.html('<tr><td colspan="6">Učitavanje upita...</td></tr>'); // Prikazi poruku o učitavanju

            // URL endpoint koji vraća JSON podatke o upitima
            // MORATE IMPLEMENTIRATI GetPodrskaJson akciju u AdminPanelControlleru KOJA VRAĆA JSON!
            const url = '@Url.Action("GetPodrskaJson", "AdminPanel")';

            $.get(url, { searchQuery: searchQuery, page: page, sortOrder: sortOrder }, function (data) {
                console.log("Support tickets data received:", data);
                podrskaTableBody.empty(); // Isprazni postojeće redove

                if (data && data.upiti && data.upiti.length > 0) {
                    // Iteriraj kroz primljene podatke i dodaj redove u tabelu
                    $.each(data.upiti, function (index, upit) {
                         // Pretpostavljamo da JSON objekat 'upit' ima svojstva: upitID, datumUpita (kao string),
                         // korisnikEmail (ili korisnik sa email svojstvom), naslov, sadrzaj, status
                        const row = `
                            <tr>
                                <td>${formatDateTime(upit.datumUpita)}</td>
                                <td>${upit.korisnikEmail || (upit.korisnik ? upit.korisnik.email : 'N/A')}</td> @* Prilagodite pristupu emailu *@
                                <td>${upit.naslov || ''}</td>
                                @* Opcionalno: Skratite sadržaj poruke ako je predugačak *@
                                <td>${(upit.sadrzaj || '').substring(0, 100) + ((upit.sadrzaj || '').length > 100 ? '...' : '')}</td>
                                <td>${upit.status || ''}</td> @* Prilagodite prikazu statusa ako je enum *@
                                <td>
                                    @* Mailto link - mora biti dinamicki generisan sa ispravnim emailom *@
                                    @* Koristite property koji JSON vraca za email korisnika (ovdje upit.korisnikEmail) *@
                                    <a href="mailto:${upit.korisnikEmail || ''}?subject=Odgovor%20na%20Va%C5%A1%20upit&body=Po%C5%A1tovani," class="btn btn-info btn-sm">Odgovori mailom</a>
                                    <button class="delete-podrska-button btn btn-danger btn-sm" data-id="${upit.upitID}"><i class="bi bi-trash"></i> Obriši</button>
                                </td>
                            </tr>
                        `;
                        podrskaTableBody.append(row);
                    });

                    // Ovdje možete dodati logiku za renderovanje paginacije
                } else {
                    podrskaTableBody.html('<tr><td colspan="6">Nema dostupnih upita za podršku.</td></tr>');
                }
            }).fail(function (jqXHR, textStatus, errorThrown) {
                console.error('Error loading support tickets:', textStatus, errorThrown, jqXHR.responseText);
                 podrskaTableBody.html('<tr><td colspan="6"><div class="alert alert-danger">Greška prilikom učitavanja upita: ' + (jqXHR.responseText || errorThrown) + '</div></td></tr>');
            });
        }

        // Učitaj listu upita kada se parcijalni view učita
        loadUpitiList(searchInput.val() || '@Model.SearchQuery');

        // Handle-anje klika na dugme "Pretraži"
        searchButton.on('click', function () {
            const searchQuery = searchInput.val();
            loadUpitiList(searchQuery); // Učitaj listu sa novim parametrom pretrage
        });

         // Opcionalno: Pretraga na pritisak Enter tastera
         searchInput.keypress(function(e) {
             if(e.which == 13) {
                 e.preventDefault();
                 searchButton.click();
             }
         });


        // Handle-anje klika na dugme "Obriši upit" (Delegacija događaja)
        $(document).on('click', '.delete-podrska-button', function () {
            var upitId = $(this).data('id');

            if (confirm('Da li ste sigurni da želite obrisati ovaj upit za podršku?')) {
                $.ajax({
                    url: '@Url.Action("DeletePodrska", "AdminPanel")', // Endpoint za brisanje
                    method: 'POST', // Koristite POST za brisanje
                    data: { id: upitId }, // Pošaljite ID upita
                    headers: { // Dodajte Anti-forgery token ako koristite
                         // Ukljucite Anti-forgery token u vas _CustomLayout.cshtml sa @Html.AntiForgeryToken()
                         // i dohvatite ga ovdje $('input[name="__RequestVerificationToken"]').val()
                         // Ako vec nije globalno dohvacen ili u layoutu
                         'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function (response) {
                        console.log("Delete successful:", response);
                        alert('Upit za podršku uspješno obrisan.');
                        // Osvježite SAMO listu upita
                        loadUpitiList(searchInput.val()); // Učitaj listu sa trenutnim parametrom pretrage
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.error('Error deleting support ticket:', errorThrown, textStatus, jqXHR.responseText);
                        alert('Došlo je do greške prilikom brisanja upita.');
                    }
                });
            }
        });

        // Dodajte handle-ere za klikove na dugmad za paginaciju ako ih implementirate

    }); // Kraj document.ready
</script>

@* Potrebne klijentske skripte ako imate dinamičke forme ili klijentsku validaciju u ovoj sekciji *@
@* <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script> *@
@* <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script> *@